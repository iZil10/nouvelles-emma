<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Des nouvelles d'Emma</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíõ</text></svg>">
</head>
<body>

  <!-- Petits coeurs flottants en arriere-plan -->
  <div class="hearts-bg" id="hearts"></div>

  <!-- En-tete -->
  <header class="header">
    <h1>Des nouvelles d'Emma</h1>
    <p class="subtitle">Un petit coin pour vous tenir au courant</p>
  </header>

  <!-- Contenu principal : 2 colonnes -->
  <div class="two-columns">

    <!-- Colonne gauche : Historique -->
    <main class="col-left">
      <div class="info-banner">
        Cette page est mise a jour regulierement pour vous donner
        des nouvelles d'Emma. Revenez de temps en temps !
      </div>

      <!-- Formulaire public de nouvelles -->
      <div class="public-form-wrapper" id="public-form-wrapper">
        <button class="public-form-toggle" id="public-form-toggle">Partager une nouvelle</button>
        <form class="public-form" id="public-form">
          <div class="public-form-feedback" id="public-form-feedback"></div>
          <input type="text" id="public-name" placeholder="Ton prenom" maxlength="50" required>

          <label class="public-form-label">Choisis un emoji</label>
          <div class="public-emoji-picker" id="public-emoji-picker">
            <button type="button" class="public-emoji-btn selected" data-emoji="üíõ">üíõ</button>
            <button type="button" class="public-emoji-btn" data-emoji="üè•">üè•</button>
            <button type="button" class="public-emoji-btn" data-emoji="üí™">üí™</button>
            <button type="button" class="public-emoji-btn" data-emoji="üå∏">üå∏</button>
            <button type="button" class="public-emoji-btn" data-emoji="‚ú®">‚ú®</button>
            <button type="button" class="public-emoji-btn" data-emoji="üéâ">üéâ</button>
            <button type="button" class="public-emoji-btn" data-emoji="üòä">üòä</button>
            <button type="button" class="public-emoji-btn" data-emoji="üåà">üåà</button>
            <button type="button" class="public-emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
            <button type="button" class="public-emoji-btn" data-emoji="üê±">üê±</button>
            <button type="button" class="public-emoji-btn" data-emoji="‚òÄÔ∏è">‚òÄÔ∏è</button>
            <button type="button" class="public-emoji-btn" data-emoji="üåª">üåª</button>
          </div>

          <input type="text" id="public-titre" placeholder="Titre de ta nouvelle" maxlength="100" required>
          <textarea id="public-contenu" placeholder="Ecris ta nouvelle ici..." maxlength="2000" required></textarea>

          <div class="public-photo-section">
            <label class="public-photo-label" for="public-photo">Ajouter une photo (optionnel)</label>
            <input type="file" id="public-photo" accept="image/*" class="public-photo-input">
            <div class="public-photo-preview" id="public-photo-preview"></div>
          </div>

          <button type="submit" class="public-submit" id="public-submit">Publier</button>
        </form>
      </div>

      <div class="timeline" id="timeline">
        <!-- Les nouvelles sont ajoutees ici automatiquement -->
      </div>
    </main>

    <!-- Colonne droite : Livre d'or -->
    <section class="col-right">
      <h2 class="guestbook-title">Un petit mot pour Emma</h2>

      <form class="guestbook-form" id="guestbook-form">
        <div class="form-feedback" id="form-feedback"></div>
        <input type="text" id="msg-name" placeholder="Ton prenom" maxlength="50" required>
        <textarea id="msg-text" placeholder="Un petit mot d'encouragement..." maxlength="500" required></textarea>
        <button type="submit" id="msg-submit">Envoyer</button>
      </form>

      <div class="guestbook-messages" id="guestbook-messages">
        <div class="guestbook-loading">Chargement des messages...</div>
      </div>
    </section>

  </div>

  <!-- Panneau admin (cache) -->
  <div class="admin-overlay" id="admin-overlay">
    <div class="admin-panel">
      <button class="admin-close" id="admin-close">&times;</button>
      <h2 class="admin-title">Mode admin</h2>

      <div class="admin-pin-section" id="admin-pin-section">
        <p style="color:#7b5b6e; margin-bottom:0.8rem;">Entre ton code pour activer le mode suppression :</p>
        <input type="password" class="admin-pin-input" id="admin-pin" maxlength="6" inputmode="numeric" autocomplete="off">
        <div class="admin-pin-error" id="admin-pin-error">Code incorrect</div>
      </div>

      <div class="admin-confirmed" id="admin-confirmed" style="display:none; text-align:center;">
        <p style="color:#2e7d32; font-weight:600;">Mode suppression active</p>
        <p style="color:#7b5b6e; font-size:0.9rem; margin-top:0.5rem;">Les boutons supprimer sont maintenant visibles sur les nouvelles.</p>
      </div>
    </div>
  </div>

  <!-- Pied de page -->
  <footer class="footer">
    Fait avec <span class="heart" id="admin-trigger">&#10084;</span> pour Emma
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <!-- Configuration Firebase + Nouvelles -->
  <script src="firebase-config.js"></script>
  <script src="updates.js"></script>

  <script>
    var db, updatesRef, messagesRef, repliesRef, newsCommentsRef, storage, storageRef;
    var ADMIN_PIN = '012139';
    var firebaseUpdates = [];
    var allReplies = {};
    var allNewsComments = {};
    var allNewsLikes = {};
    var renderUpdatesTimer = null;

    // --- Protection XSS ---
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // --- Formater la date ---
    function formatDate(timestamp) {
      var d = new Date(timestamp);
      var mois = ['jan', 'fev', 'mars', 'avril', 'mai', 'juin',
                  'juil', 'aout', 'sept', 'oct', 'nov', 'dec'];
      return d.getDate() + ' ' + mois[d.getMonth()] + ' ' + d.getFullYear()
             + ' a ' + d.getHours() + 'h' + String(d.getMinutes()).padStart(2, '0');
    }

    function formatDateShort(timestamp) {
      var d = new Date(timestamp);
      var mois = ['janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin',
                  'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre'];
      return d.getDate() + ' ' + mois[d.getMonth()] + ' ' + d.getFullYear()
             + ' a ' + d.getHours() + 'h' + String(d.getMinutes()).padStart(2, '0');
    }

    // --- Likes helpers (localStorage) ---
    function getLikedUpdates() {
      try {
        return JSON.parse(localStorage.getItem('emma-liked-updates') || '[]');
      } catch(e) {
        return [];
      }
    }

    function isLiked(key) {
      return getLikedUpdates().indexOf(key) !== -1;
    }

    function markAsLiked(key) {
      try {
        var liked = getLikedUpdates();
        if (liked.indexOf(key) === -1) {
          liked.push(key);
          localStorage.setItem('emma-liked-updates', JSON.stringify(liked));
        }
      } catch(e) {}
    }

    // --- Authored content helpers (localStorage) ---
    function getMyUpdates() {
      try { return JSON.parse(localStorage.getItem('emma-my-updates') || '[]'); }
      catch(e) { return []; }
    }
    function isMyUpdate(key) { return getMyUpdates().indexOf(key) !== -1; }
    function addMyUpdate(key) {
      try {
        var mine = getMyUpdates();
        if (mine.indexOf(key) === -1) { mine.push(key); localStorage.setItem('emma-my-updates', JSON.stringify(mine)); }
      } catch(e) {}
    }

    function getMyComments() {
      try { return JSON.parse(localStorage.getItem('emma-my-comments') || '[]'); }
      catch(e) { return []; }
    }
    function isMyComment(commentId) { return getMyComments().indexOf(commentId) !== -1; }
    function addMyComment(commentId) {
      try {
        var mine = getMyComments();
        if (mine.indexOf(commentId) === -1) { mine.push(commentId); localStorage.setItem('emma-my-comments', JSON.stringify(mine)); }
      } catch(e) {}
    }

    // --- Slugify pour cles stables ---
    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').substring(0, 30);
    }

    // --- Debounce renderUpdates ---
    function scheduleRenderUpdates() {
      clearTimeout(renderUpdatesTimer);
      renderUpdatesTimer = setTimeout(renderUpdates, 50);
    }

    // --- Afficher les nouvelles (statiques + Firebase) ---
    function renderUpdates() {
      var timeline = document.getElementById('timeline');

      // Ajouter une cle stable aux nouvelles statiques
      var staticUpdates = (UPDATES || []).map(function(u) {
        var copy = {};
        for (var k in u) copy[k] = u[k];
        copy.staticKey = 'static-' + slugify(u.titre);
        if (u.timestamp) {
          copy.date = formatDateShort(u.timestamp);
        }
        return copy;
      });

      var allUpdates = firebaseUpdates.concat(staticUpdates);

      if (allUpdates.length === 0) {
        timeline.innerHTML = '<div class="empty-state">Pas encore de nouvelles... Revenez bientot !</div>';
        return;
      }

      timeline.innerHTML = allUpdates.map(function(update) {
        var isFirebase = !!update.firebaseKey;
        var key = update.firebaseKey || update.staticKey;

        // Bouton supprimer (admin, Firebase uniquement)
        var deleteBtn = isFirebase
          ? '<button class="update-delete" data-key="' + update.firebaseKey + '" title="Supprimer">&times;</button>'
          : '';

        // Auteur
        var authorHtml = update.author
          ? '<div class="update-author">Par ' + escapeHtml(update.author) + '</div>'
          : '';

        // Photo
        var photoHtml = update.photoUrl
          ? '<div class="update-photo"><img src="' + escapeHtml(update.photoUrl) + '" alt="Photo" loading="lazy"></div>'
          : '';

        // Like (toutes les nouvelles)
        var liked = isLiked(key);
        var likeCount = allNewsLikes[key] || 0;
        var likeHtml = '<button class="update-like' + (liked ? ' liked' : '') + '" data-key="' + key + '">' +
          '<span class="like-heart">' + (liked ? '\u2764\uFE0F' : '\u{1F90D}') + '</span>' +
          '<span class="like-count">' + (likeCount > 0 ? likeCount : '') + '</span>' +
        '</button>';

        // Bouton commenter (toutes les nouvelles)
        var comments = allNewsComments[key] || [];
        var commentCountText = comments.length > 0 ? ' (' + comments.length + ')' : '';
        var commentBtnHtml = '<button class="update-comment-toggle" data-key="' + key + '">Commenter' + commentCountText + '</button>';

        // Bouton modifier (auteur Firebase uniquement)
        var editBtnHtml = '';
        if (isFirebase && isMyUpdate(update.firebaseKey)) {
          editBtnHtml = '<button class="update-edit-btn" data-key="' + update.firebaseKey + '">Modifier</button>';
        }

        // Barre d'actions
        var actionsHtml = '<div class="update-actions">' + likeHtml + commentBtnHtml + editBtnHtml + '</div>';

        // Liste des commentaires + formulaire (toutes les nouvelles)
        var commentsListHtml = '';
        if (comments.length > 0) {
          commentsListHtml = '<div class="news-comments-list">' +
            comments.map(function(c) {
              var editCommentBtn = isMyComment(c.key)
                ? '<button class="news-comment-edit" data-updatekey="' + key + '" data-commentkey="' + c.key + '">Modifier</button>'
                : '';
              return '<div class="news-comment">' +
                '<div class="news-comment-header">' +
                  '<span class="news-comment-name">' + escapeHtml(c.name) + '</span>' +
                  editCommentBtn +
                  '<span class="news-comment-date">' + formatDate(c.timestamp) + '</span>' +
                '</div>' +
                '<div class="news-comment-text">' + escapeHtml(c.text) + '</div>' +
              '</div>';
            }).join('') +
          '</div>';
        }

        var commentsSection = commentsListHtml +
          '<div class="news-comment-form" id="news-comment-form-' + key + '">' +
            '<input type="text" placeholder="Ton prenom" maxlength="50" class="news-comment-name">' +
            '<textarea placeholder="Ton commentaire..." maxlength="500" class="news-comment-text"></textarea>' +
            '<button type="button" class="news-comment-send" data-key="' + key + '">Envoyer</button>' +
          '</div>';

        return '<article class="update-card">' +
          deleteBtn +
          '<div class="update-date">' + escapeHtml(update.date) + '</div>' +
          authorHtml +
          '<h2 class="update-title"><span class="emoji">' + update.emoji + '</span>' + escapeHtml(update.titre) + '</h2>' +
          photoHtml +
          '<div class="update-content">' + escapeHtml(update.contenu) + '</div>' +
          actionsHtml +
          commentsSection +
        '</article>';
      }).join('');

      // --- Event listeners ---

      // Supprimer (Firebase uniquement)
      timeline.querySelectorAll('.update-delete').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var key = btn.dataset.key;
          if (confirm('Supprimer cette nouvelle ?')) {
            updatesRef.child(key).remove();
            if (newsCommentsRef) newsCommentsRef.child(key).remove();
          }
        });
      });

      // Like (toutes les nouvelles)
      timeline.querySelectorAll('.update-like').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var key = btn.dataset.key;
          if (isLiked(key)) return;
          if (!updatesRef) return;
          // Feedback visuel immediat
          btn.classList.add('liked');
          btn.querySelector('.like-heart').textContent = '\u2764\uFE0F';
          btn.style.pointerEvents = 'none';
          var currentCount = allNewsLikes[key] || 0;
          updatesRef.child(key).child('likes').set(currentCount + 1).then(function() {
            markAsLiked(key);
          }).catch(function() {
            // Rollback visuel si echec
            btn.classList.remove('liked');
            btn.querySelector('.like-heart').textContent = '\u{1F90D}';
            btn.style.pointerEvents = '';
          });
        });
      });

      // Toggle commentaires
      timeline.querySelectorAll('.update-comment-toggle').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var key = btn.dataset.key;
          var form = document.getElementById('news-comment-form-' + key);
          form.classList.toggle('visible');
          if (form.classList.contains('visible')) {
            form.querySelector('.news-comment-name').focus();
          }
        });
      });

      // Envoyer commentaire
      timeline.querySelectorAll('.news-comment-send').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var key = btn.dataset.key;
          var form = document.getElementById('news-comment-form-' + key);
          var nameInput = form.querySelector('.news-comment-name');
          var textInput = form.querySelector('.news-comment-text');
          var name = nameInput.value.trim();
          var text = textInput.value.trim();
          if (!name || !text) return;

          btn.disabled = true;
          btn.textContent = 'Envoi...';

          newsCommentsRef.child(key).push({
            name: name,
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          }).then(function(ref) {
            addMyComment(ref.key);
            nameInput.value = '';
            textInput.value = '';
            form.classList.remove('visible');
            btn.disabled = false;
            btn.textContent = 'Envoyer';
          }).catch(function() {
            btn.disabled = false;
            btn.textContent = 'Envoyer';
          });
        });
      });

      // Modifier une publication (Firebase uniquement)
      timeline.querySelectorAll('.update-edit-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var key = btn.dataset.key;
          var card = btn.closest('.update-card');

          var existing = card.querySelector('.update-edit-form');
          if (existing) { existing.remove(); return; }

          var update = null;
          for (var i = 0; i < firebaseUpdates.length; i++) {
            if (firebaseUpdates[i].firebaseKey === key) { update = firebaseUpdates[i]; break; }
          }
          if (!update) return;

          var formDiv = document.createElement('div');
          formDiv.className = 'update-edit-form';
          formDiv.innerHTML =
            '<input type="text" class="edit-titre" value="' + escapeHtml(update.titre).replace(/"/g, '&quot;') + '" maxlength="100">' +
            '<textarea class="edit-contenu" maxlength="2000">' + escapeHtml(update.contenu) + '</textarea>' +
            '<div class="edit-form-actions">' +
              '<button type="button" class="edit-save">Enregistrer</button>' +
              '<button type="button" class="edit-cancel">Annuler</button>' +
            '</div>';
          card.appendChild(formDiv);
          formDiv.querySelector('.edit-titre').focus();

          formDiv.querySelector('.edit-cancel').addEventListener('click', function() {
            formDiv.remove();
          });

          formDiv.querySelector('.edit-save').addEventListener('click', function() {
            var newTitre = formDiv.querySelector('.edit-titre').value.trim();
            var newContenu = formDiv.querySelector('.edit-contenu').value.trim();
            if (!newTitre || !newContenu) return;

            var saveBtn = formDiv.querySelector('.edit-save');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Enregistrement...';

            updatesRef.child(key).update({
              titre: newTitre,
              contenu: newContenu
            }).then(function() {
              formDiv.remove();
            }).catch(function() {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Enregistrer';
            });
          });
        });
      });

      // Modifier un commentaire
      timeline.querySelectorAll('.news-comment-edit').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var updateKey = btn.dataset.updatekey;
          var commentKey = btn.dataset.commentkey;
          var commentDiv = btn.closest('.news-comment');
          var textDiv = commentDiv.querySelector('.news-comment-text');

          var comments = allNewsComments[updateKey] || [];
          var comment = null;
          for (var i = 0; i < comments.length; i++) {
            if (comments[i].key === commentKey) { comment = comments[i]; break; }
          }
          if (!comment) return;

          var originalText = comment.text;
          textDiv.innerHTML =
            '<textarea class="edit-comment-textarea" maxlength="500">' + escapeHtml(originalText) + '</textarea>' +
            '<div class="edit-form-actions">' +
              '<button type="button" class="edit-comment-save">Enregistrer</button>' +
              '<button type="button" class="edit-comment-cancel">Annuler</button>' +
            '</div>';
          btn.style.display = 'none';
          textDiv.querySelector('.edit-comment-textarea').focus();

          textDiv.querySelector('.edit-comment-cancel').addEventListener('click', function() {
            textDiv.textContent = originalText;
            btn.style.display = '';
          });

          textDiv.querySelector('.edit-comment-save').addEventListener('click', function() {
            var newText = textDiv.querySelector('.edit-comment-textarea').value.trim();
            if (!newText) return;

            var saveBtn = textDiv.querySelector('.edit-comment-save');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Enregistrement...';

            newsCommentsRef.child(updateKey).child(commentKey).update({
              text: newText
            }).then(function() {
              // Le listener Firebase va re-render
            }).catch(function() {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Enregistrer';
            });
          });
        });
      });
    }

    // --- Petits coeurs flottants ---
    function createHearts() {
      var container = document.getElementById('hearts');
      var symbols = ['\u{1F49B}', '\u{1F338}', '\u2728', '\u{1F497}', '\u{1FA77}', '\u{1F431}', '\u{1F63A}', '\u{1F638}', '\u{1F43E}'];

      for (var i = 0; i < 12; i++) {
        var heart = document.createElement('span');
        heart.className = 'floating-heart';
        heart.textContent = symbols[Math.floor(Math.random() * symbols.length)];
        heart.style.left = Math.random() * 100 + '%';
        heart.style.animationDuration = (12 + Math.random() * 18) + 's';
        heart.style.animationDelay = (Math.random() * 15) + 's';
        heart.style.fontSize = (0.8 + Math.random() * 0.8) + 'rem';
        container.appendChild(heart);
      }
    }

    // --- Init Firebase ---
    function initFirebase() {
      if (!firebaseConfig || firebaseConfig.apiKey === 'REMPLACE_MOI') {
        document.getElementById('guestbook-messages').innerHTML =
          '<div class="guestbook-empty">Le livre d\'or sera disponible bientot !</div>';
        return;
      }

      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      messagesRef = db.ref('messages');
      updatesRef = db.ref('updates');
      repliesRef = db.ref('replies');
      newsCommentsRef = db.ref('news-comments');

      // Init Storage (try/catch au cas ou le service n'est pas active)
      try {
        storage = firebase.storage();
        storageRef = storage.ref();
      } catch(e) {
        storage = null;
        storageRef = null;
      }

      initUpdatesListener();
      initGuestbook();
      initRepliesListener();
      initNewsCommentsListener();
    }

    // --- Ecouter les nouvelles Firebase ---
    function initUpdatesListener() {
      updatesRef.orderByChild('timestamp').on('value', function(snapshot) {
        firebaseUpdates = [];
        allNewsLikes = {};
        snapshot.forEach(function(child) {
          var u = child.val();
          // Stocker les likes de toutes les entrees (y compris les entrees de like pour nouvelles statiques)
          if (u.likes) {
            allNewsLikes[child.key] = u.likes;
          }
          // Ne garder que les vraies nouvelles (avec timestamp)
          if (!u.timestamp) return;
          firebaseUpdates.push({
            firebaseKey: child.key,
            date: formatDateShort(u.timestamp),
            emoji: u.emoji,
            titre: u.titre,
            contenu: u.contenu,
            timestamp: u.timestamp,
            author: u.author || '',
            photoUrl: u.photoUrl || '',
            likes: u.likes || 0
          });
        });
        // Plus recentes en premier
        firebaseUpdates.reverse();
        scheduleRenderUpdates();
      });
    }

    // --- Ecouter les commentaires des nouvelles ---
    function initNewsCommentsListener() {
      newsCommentsRef.on('value', function(snapshot) {
        allNewsComments = {};
        snapshot.forEach(function(parentSnap) {
          var updateKey = parentSnap.key;
          allNewsComments[updateKey] = [];
          parentSnap.forEach(function(commentSnap) {
            var c = commentSnap.val();
            c.key = commentSnap.key;
            allNewsComments[updateKey].push(c);
          });
          allNewsComments[updateKey].sort(function(a, b) { return a.timestamp - b.timestamp; });
        });
        scheduleRenderUpdates();
      });
    }

    // --- Ecouter les reponses du livre d'or ---
    function initRepliesListener() {
      repliesRef.on('value', function(snapshot) {
        allReplies = {};
        snapshot.forEach(function(parentSnap) {
          var parentId = parentSnap.key;
          allReplies[parentId] = [];
          parentSnap.forEach(function(replySnap) {
            allReplies[parentId].push(replySnap.val());
          });
          allReplies[parentId].sort(function(a, b) { return a.timestamp - b.timestamp; });
        });
        renderMessages();
      });
    }

    // --- Afficher les messages du livre d'or ---
    function renderMessages() {
      var container = document.getElementById('guestbook-messages');
      if (!window._guestbookMessages || window._guestbookMessages.length === 0) {
        container.innerHTML = '<div class="guestbook-empty">Sois le premier a laisser un petit mot !</div>';
        return;
      }

      container.innerHTML = window._guestbookMessages.map(function(msg) {
        var replies = allReplies[msg.key] || [];
        var repliesHtml = '';

        if (replies.length > 0) {
          repliesHtml = '<div class="replies-list">' +
            replies.map(function(r) {
              return '<div class="reply-item">' +
                '<div class="reply-item-header">' +
                  '<span class="reply-item-name">' + escapeHtml(r.name) + '</span>' +
                  '<span class="reply-item-date">' + formatDate(r.timestamp) + '</span>' +
                '</div>' +
                '<div class="reply-item-text">' + escapeHtml(r.text) + '</div>' +
              '</div>';
            }).join('') +
          '</div>';
        }

        var replyCountText = replies.length > 0
          ? '<span class="replies-count">(' + replies.length + ')</span>'
          : '';

        return '<div class="guestbook-msg">' +
          '<div class="guestbook-msg-header">' +
            '<span class="guestbook-msg-name">' + escapeHtml(msg.name) + '</span>' +
            '<span class="guestbook-msg-date">' + formatDate(msg.timestamp) + '</span>' +
          '</div>' +
          '<div class="guestbook-msg-text">' + escapeHtml(msg.text) + '</div>' +
          '<div class="guestbook-msg-actions">' +
            '<button class="reply-toggle" data-msgkey="' + msg.key + '">Repondre' + replyCountText + '</button>' +
          '</div>' +
          repliesHtml +
          '<div class="reply-form" id="reply-form-' + msg.key + '">' +
            '<input type="text" placeholder="Ton prenom" maxlength="50" class="reply-name">' +
            '<textarea placeholder="Ta reponse..." maxlength="500" class="reply-text"></textarea>' +
            '<button type="button" class="reply-send" data-msgkey="' + msg.key + '">Envoyer</button>' +
          '</div>' +
        '</div>';
      }).join('');

      // Toggle reply forms
      container.querySelectorAll('.reply-toggle').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var form = document.getElementById('reply-form-' + btn.dataset.msgkey);
          form.classList.toggle('visible');
          if (form.classList.contains('visible')) {
            form.querySelector('.reply-name').focus();
          }
        });
      });

      // Send replies
      container.querySelectorAll('.reply-send').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var msgKey = btn.dataset.msgkey;
          var form = document.getElementById('reply-form-' + msgKey);
          var nameInput = form.querySelector('.reply-name');
          var textInput = form.querySelector('.reply-text');
          var name = nameInput.value.trim();
          var text = textInput.value.trim();
          if (!name || !text) return;

          btn.disabled = true;
          btn.textContent = 'Envoi...';

          repliesRef.child(msgKey).push({
            name: name,
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          }).then(function() {
            nameInput.value = '';
            textInput.value = '';
            form.classList.remove('visible');
            btn.disabled = false;
            btn.textContent = 'Envoyer';
          }).catch(function() {
            btn.disabled = false;
            btn.textContent = 'Envoyer';
          });
        });
      });
    }

    // --- Livre d'or ---
    function initGuestbook() {
      messagesRef.orderByChild('timestamp').on('value', function(snapshot) {
        window._guestbookMessages = [];

        snapshot.forEach(function(child) {
          var msg = child.val();
          msg.key = child.key;
          window._guestbookMessages.push(msg);
        });

        window._guestbookMessages.reverse();
        renderMessages();
      });

      document.getElementById('guestbook-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var nameInput = document.getElementById('msg-name');
        var textInput = document.getElementById('msg-text');
        var submitBtn = document.getElementById('msg-submit');
        var feedback = document.getElementById('form-feedback');
        var name = nameInput.value.trim();
        var text = textInput.value.trim();
        if (!name || !text) return;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Envoi...';

        messagesRef.push({
          name: name,
          text: text,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(function() {
          nameInput.value = '';
          textInput.value = '';
          feedback.className = 'form-feedback success';
          feedback.textContent = 'Merci pour ton message !';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Envoyer';
          setTimeout(function() { feedback.className = 'form-feedback'; }, 3000);
        }).catch(function() {
          feedback.className = 'form-feedback error';
          feedback.textContent = 'Oups, erreur... Reessaie !';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Envoyer';
        });
      });
    }

    // --- Formulaire public de nouvelles ---
    function initPublicForm() {
      var toggle = document.getElementById('public-form-toggle');
      var form = document.getElementById('public-form');
      var selectedEmoji = '\u{1F49B}';
      var photoFile = null;

      // Toggle formulaire
      toggle.addEventListener('click', function() {
        form.classList.toggle('visible');
        toggle.textContent = form.classList.contains('visible') ? 'Annuler' : 'Partager une nouvelle';
      });

      // Emoji picker
      document.getElementById('public-emoji-picker').addEventListener('click', function(e) {
        var btn = e.target.closest('.public-emoji-btn');
        if (!btn) return;
        document.querySelectorAll('.public-emoji-btn').forEach(function(b) {
          b.classList.remove('selected');
        });
        btn.classList.add('selected');
        selectedEmoji = btn.dataset.emoji;
      });

      // Photo preview
      var photoInput = document.getElementById('public-photo');
      var photoPreview = document.getElementById('public-photo-preview');

      photoInput.addEventListener('change', function() {
        photoPreview.innerHTML = '';
        photoFile = null;
        if (photoInput.files && photoInput.files[0]) {
          var file = photoInput.files[0];
          // Valider le type
          if (!file.type.startsWith('image/')) {
            photoPreview.innerHTML = '<div class="photo-error">Ce fichier n\'est pas une image.</div>';
            photoInput.value = '';
            return;
          }
          // Valider la taille (5 Mo)
          if (file.size > 5 * 1024 * 1024) {
            photoPreview.innerHTML = '<div class="photo-error">L\'image est trop lourde (max 5 Mo).</div>';
            photoInput.value = '';
            return;
          }
          photoFile = file;
          var reader = new FileReader();
          reader.onload = function(e) {
            photoPreview.innerHTML = '<img src="' + e.target.result + '" alt="Preview"><button type="button" class="photo-remove">Retirer</button>';
            photoPreview.querySelector('.photo-remove').addEventListener('click', function() {
              photoFile = null;
              photoInput.value = '';
              photoPreview.innerHTML = '';
            });
          };
          reader.readAsDataURL(file);
        }
      });

      // Soumission du formulaire
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var nameInput = document.getElementById('public-name');
        var titreInput = document.getElementById('public-titre');
        var contenuInput = document.getElementById('public-contenu');
        var submitBtn = document.getElementById('public-submit');
        var feedback = document.getElementById('public-form-feedback');

        var name = nameInput.value.trim();
        var titre = titreInput.value.trim();
        var contenu = contenuInput.value.trim();
        if (!name || !titre || !contenu || !updatesRef) return;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Publication...';

        function publishUpdate(photoUrl) {
          var data = {
            emoji: selectedEmoji,
            titre: titre,
            contenu: contenu,
            author: name,
            likes: 0,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };
          if (photoUrl) data.photoUrl = photoUrl;

          updatesRef.push(data).then(function(ref) {
            addMyUpdate(ref.key);
            nameInput.value = '';
            titreInput.value = '';
            contenuInput.value = '';
            photoFile = null;
            photoInput.value = '';
            photoPreview.innerHTML = '';
            // Reset emoji
            document.querySelectorAll('.public-emoji-btn').forEach(function(b) { b.classList.remove('selected'); });
            document.querySelector('.public-emoji-btn').classList.add('selected');
            selectedEmoji = '\u{1F49B}';

            feedback.className = 'public-form-feedback success';
            feedback.textContent = 'Nouvelle publiee !';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Publier';
            setTimeout(function() {
              feedback.className = 'public-form-feedback';
              form.classList.remove('visible');
              toggle.textContent = 'Partager une nouvelle';
            }, 2000);
          }).catch(function() {
            feedback.className = 'public-form-feedback error';
            feedback.textContent = 'Erreur... Reessaie !';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Publier';
          });
        }

        // Upload photo si presente
        if (photoFile && storage) {
          var filename = Date.now() + '_' + photoFile.name;
          var ref = storageRef.child('news-photos/' + filename);
          ref.put(photoFile).then(function(snapshot) {
            return snapshot.ref.getDownloadURL();
          }).then(function(url) {
            publishUpdate(url);
          }).catch(function() {
            feedback.className = 'public-form-feedback error';
            feedback.textContent = 'Erreur lors de l\'upload de la photo.';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Publier';
          });
        } else {
          publishUpdate(null);
        }
      });
    }

    // --- Admin panel (PIN pour mode suppression uniquement) ---
    function initAdmin() {
      var overlay = document.getElementById('admin-overlay');
      var trigger = document.getElementById('admin-trigger');
      var closeBtn = document.getElementById('admin-close');
      var pinInput = document.getElementById('admin-pin');
      var pinError = document.getElementById('admin-pin-error');
      var pinSection = document.getElementById('admin-pin-section');
      var confirmed = document.getElementById('admin-confirmed');

      // Ouvrir le panneau en cliquant sur le coeur
      trigger.addEventListener('click', function() {
        overlay.classList.add('visible');
        pinInput.value = '';
        pinError.style.display = 'none';
        pinSection.style.display = 'block';
        confirmed.style.display = 'none';
        document.body.classList.remove('admin-mode');
        setTimeout(function() { pinInput.focus(); }, 100);
      });

      // Fermer
      closeBtn.addEventListener('click', function() {
        overlay.classList.remove('visible');
      });
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) overlay.classList.remove('visible');
      });

      // Verification du code PIN
      pinInput.addEventListener('input', function() {
        if (pinInput.value.length >= 6) {
          if (pinInput.value === ADMIN_PIN) {
            pinSection.style.display = 'none';
            confirmed.style.display = 'block';
            document.body.classList.add('admin-mode');
          } else {
            pinError.style.display = 'block';
            pinInput.value = '';
          }
        }
      });
    }

    // --- Lancer ---
    renderUpdates();
    createHearts();
    initFirebase();
    initPublicForm();
    initAdmin();
  </script>

</body>
</html>
